<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Real-Time Edge Detection Viewer</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
  /* ------- identical visual CSS (shortened) ------------------ */
  body{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;min-height:100vh}
  .main-container{max-width:1200px;margin:0 auto;padding:20px}
  .header{text-align:center;margin-bottom:30px}.header h1{background:linear-gradient(45deg,#ff6b6b,#4ecdc4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:2.5rem;font-weight:700;margin-bottom:10px}
  .video-container{position:relative;width:100%;max-width:640px;margin:0 auto 20px;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  #video,#canvasOutput{width:100%;height:auto;display:block}
  .controls{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:20px 0}
  .filter-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);color:#fff;padding:10px 20px;border-radius:25px;transition:.3s;backdrop-filter:blur(10px)}
  .filter-btn:hover{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.4);transform:translateY(-2px)}
  .filter-btn.active{background:linear-gradient(45deg,#ff6b6b,#4ecdc4);border-color:transparent}
  .status{margin:20px 0;text-align:center;padding:15px;border-radius:10px;backdrop-filter:blur(10px)}
  .status.loading{background:rgba(255,193,7,.2);border:1px solid rgba(255,193,7,.5)}
  .status.ready{background:rgba(40,167,69,.2);border:1px solid rgba(40,167,69,.5)}
  .status.error{background:rgba(220,53,69,.2);border:1px solid rgba(220,53,69,.5)}
  .metrics{display:flex;justify-content:center;gap:30px;margin:20px 0;flex-wrap:wrap}
  .metric{background:rgba(255,255,255,.1);padding:15px;border-radius:10px;min-width:120px;text-align:center;backdrop-filter:blur(10px)}
  .metric-value{font-size:1.5rem;font-weight:700;color:#4ecdc4}
  .metric-label{font-size:.9rem;opacity:.8;margin-top:5px}
  </style>
</head>
<body>
<div class="main-container">
  <div class="header">
    <h1>üöÄ Real-Time Edge Detection Viewer</h1>
    <p class="lead">Web-based Computer-Vision Demo</p>
  </div>

  <div class="status loading" id="status">Initializing OpenCV.js‚Ä¶</div>

  <div class="video-container">
    <video id="video" autoplay playsinline muted style="display:none;"></video>
    <canvas id="canvasOutput" style="display:none;"></canvas>
  </div>

  <div class="controls" id="controls" style="display:none;">
    <button class="filter-btn active" onclick="setFilter('raw')"       id="rawBtn">üé• Raw</button>
    <button class="filter-btn"        onclick="setFilter('gray')"      id="grayBtn">‚ö´ Gray</button>
    <button class="filter-btn"        onclick="setFilter('blur')"      id="blurBtn">üå´Ô∏è Blur</button>
    <button class="filter-btn"        onclick="setFilter('edge')"      id="edgeBtn">‚ö° Edge</button>
    <button class="filter-btn"        onclick="setFilter('threshold')" id="thresholdBtn">üî≤ Thresh</button>
  </div>

  <div class="metrics" id="metrics" style="display:none;">
    <div class="metric"><div class="metric-value" id="fpsValue">0</div><div class="metric-label">FPS</div></div>
    <div class="metric"><div class="metric-value" id="processTimeValue">0</div><div class="metric-label">ms</div></div>
    <div class="metric"><div class="metric-value" id="resolutionValue">-</div><div class="metric-label">Res</div></div>
  </div>
</div>

<script>
/* ========== DOM refs ========================================= */
const video   = document.getElementById('video');
const canvas  = document.getElementById('canvasOutput');
const ctx     = canvas.getContext('2d');
const statusD = document.getElementById('status');
const controls= document.getElementById('controls');
const metrics = document.getElementById('metrics');

/* ========== state ============================================ */
let filter='raw', streaming=false;
let src,dst,gray,blurred,cap;
let isOpenCV=false;
let frameCnt=0,lastT=Date.now(),lastProc=0;

/* ========== helpers ========================================== */
function setStatus(msg,cls='loading'){statusD.textContent=msg;statusD.className=`status ${cls}`;}
function setFilter(f){filter=f;document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));document.getElementById(f+'Btn').classList.add('active');}

/* ========== OpenCV loader (two CDNs) ========================= */
const cdns=['https://docs.opencv.org/4.8.0/opencv.js','https://cdn.jsdelivr.net/npm/opencv.js@1.2.1/dist/opencv.js'];
let cdn=0;
(function loadCV(){
  setStatus(`Loading OpenCV.js (CDN ${cdn+1}/${cdns.length})‚Ä¶`);
  const s=document.createElement('script');s.src=cdns[cdn];s.async=true;
  s.onload=()=>{cv.onRuntimeInitialized=()=>{isOpenCV=true;setStatus('OpenCV ready ‚Äì requesting camera‚Ä¶','ready');startCam();};};
  s.onerror=()=>{cdn++; if(cdn<cdns.length) loadCV(); else{setStatus('OpenCV failed ‚Äì Canvas fallback','error');startCam();}};
  document.head.appendChild(s);
})();

/* ========== camera =========================================== */
function startCam(){
  navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:30}},audio:false})
  .then(stream=>{video.srcObject=stream;video.play();video.style.display='block';})
  .catch(e=>setStatus('Camera error: '+e.message,'error'));

  video.addEventListener('loadedmetadata',()=>{
    /* ---- copy real size to width/height attributes --------- */
    video.width  = video.videoWidth;
    video.height = video.videoHeight;
    document.getElementById('resolutionValue').textContent=`${video.width}√ó${video.height}`;
    if(!streaming) initProcessing();
  });
}

/* ========== init ============================================= */
function buildMats(){
  if(src){src.delete();dst.delete();gray.delete();blurred.delete();}
  const h=video.height, w=video.width;
  src=new cv.Mat(h,w,cv.CV_8UC4);
  dst=new cv.Mat(h,w,cv.CV_8UC1);
  gray=new cv.Mat(h,w,cv.CV_8UC1);
  blurred=new cv.Mat(h,w,cv.CV_8UC1);
}
function initProcessing(){
  canvas.width =video.width; canvas.height=video.height; canvas.style.display='block';
  if(isOpenCV){buildMats(); cap=new cv.VideoCapture(video);}
  streaming=true; controls.style.display='flex'; metrics.style.display='flex';
  setStatus('‚úÖ Ready ‚Äì processing‚Ä¶','ready'); requestAnimationFrame(loop);
}

/* ========== main loop ======================================== */
function loop(){
  if(!streaming)return; const t0=performance.now();
  try{
    if(isOpenCV){
      /* rebuild Mats if size changed (orientation swap etc.) */
      if(src.rows!==video.height||src.cols!==video.width){buildMats();}
      cap.read(src);
      switch(filter){
        case 'gray': cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY); cv.imshow('canvasOutput',gray); break;
        case 'blur': cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY); cv.GaussianBlur(gray,blurred,new cv.Size(15,15),0); cv.imshow('canvasOutput',blurred); break;
        case 'edge': cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY); cv.Canny(gray,dst,50,150); cv.imshow('canvasOutput',dst); break;
        case 'threshold': cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY); cv.threshold(gray,dst,127,255,cv.THRESH_BINARY); cv.imshow('canvasOutput',dst); break;
        default: cv.imshow('canvasOutput',src);
      }
    }else{
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
    }
  }catch(e){console.error('process error',e);}
  lastProc=Math.round(performance.now()-t0); updateMetrics(); requestAnimationFrame(loop);
}

/* ========== metrics ========================================== */
function updateMetrics(){
  frameCnt++; const now=Date.now();
  if(now-lastT>=1000){document.getElementById('fpsValue').textContent=Math.round(frameCnt*1000/(now-lastT)); document.getElementById('processTimeValue').textContent=lastProc; frameCnt=0;lastT=now;}
}

/* ========== cleanup ========================================== */
window.addEventListener('beforeunload',()=>{streaming=false; if(src){src.delete();dst.delete();gray.delete();blurred.delete();}});
</script>
</body>
</html>